@startuml
!includeurl https://raw.githubusercontent.com/RicardoNiepel/C4-PlantUML/master/C4_Component.puml
scale 0.42
!$ICONURL = "https://raw.githubusercontent.com/tupadr3/plantuml-icon-font-sprites/v3.0.0/icons"
!include $ICONURL/common.puml
!include $ICONURL/devicons2/spring_original.puml
!include $ICONURL/devicons/react.puml
!include $ICONURL/devicons/html5.puml
!include $ICONURL/devicons/postgresql.puml
!include $ICONURL/font-awesome-5/envelope.puml
!include $ICONURL/font-awesome-5/cloud.puml
!include $ICONURL/font-awesome-5/user.puml

AddElementTag("microService-java", $shape=EightSidedShape(), $bgColor="#FFDB33", $borderColor="Black", $fontColor="black", $legendText="Spring Boot Container")
AddElementTag("framework-react", $shape=RoundedBoxShape(), $bgColor="#61DBFB", $borderColor="Black", $fontColor="white", $legendText="React SPA (Vite)")
AddElementTag("storage-postgres", $shape=RoundedBoxShape(), $bgColor="#336791", $borderColor="Black", $fontColor="white", $legendText="PostgreSQL 15")
AddElementTag("webApp", $bgColor="#e34f26", $fontColor="white", $legendText="Web Application (HTML5)")

AddRelTag("purple-line", $lineColor="purple", $legendText="API Calls (REST)")
AddRelTag("blue-line", $lineColor="blue", $legendText="Auth / Sessions")
AddRelTag("green-line", $lineColor="green", $legendText="Documents (S3)")
AddRelTag("orange-line", $lineColor="orange", $legendText="Appointments (domain data)")
AddRelTag("red-line", $lineColor="red", $legendText="Analytics (domain data)")


SHOW_PERSON_OUTLINE()

title CourtierPro — C4 Level 3 (Backend API Components)

System_Boundary(cp, "CourtierPro System") {

  ' Context containers (lightweight re-declaration for consistency)
  Container(web_spa, "CourtierPro Web App", "React 18 + Vite", "Role-based SPA (Client / Broker / Admin); i18n en/fr.", $sprite="react", $tags="framework-react")
  ContainerDb(main_db, "courtierpro-db", "PostgreSQL 15", "Shared schema with bounded-context-owned tables.", $sprite="postgresql", $tags="storage-postgres")

  Container_Boundary(backend_api, "CourtierPro Backend API (Spring Boot 3)", $tags="microService-java") {

    ' ==== USER MANAGEMENT ====
    Component(UserContextController, "UserContextController", "REST Controller", "/api/v1/me/** – current user’s view")
    Component(AdminController, "AdminController", "REST Controller", "/api/v1/admin/** – admin management APIs")
    Component(UserManagementService, "UserManagementService", "Application Service", "Coordinates Client/Broker/Admin operations")
    Component(ClientRepository, "ClientRepository", "Spring Data Repository", "CRUD for Client aggregate")
    Component(BrokerRepository, "BrokerRepository", "Spring Data Repository", "CRUD for Broker aggregate")
    Component(AdminRepository, "AdminRepository", "Spring Data Repository", "CRUD for Admin aggregate")
    Component(Auth0Adapter, "Auth0Adapter", "Infrastructure Adapter", "Delegates identity operations to Auth0")

    ' ==== TRANSACTION MANAGEMENT ====
    Component(TransactionController, "TransactionController", "REST Controller", "/api/v1/transactions/** – transaction APIs")
    Component(TransactionService, "TransactionService", "Application Service", "Transaction lifecycle and queries")
    Component(TimelineService, "TimelineService", "Domain/Application Service", "Stage changes and timeline entries")
    Component(TransactionRepository, "TransactionRepository", "Spring Data Repository", "CRUD for Transaction aggregate")

    ' ==== DOCUMENT MANAGEMENT ====
    Component(DocumentRequestController, "DocumentRequestController", "REST Controller", "/api/v1/document-requests/** – broker & system")
    Component(DocumentSubmissionController, "DocumentSubmissionController", "REST Controller", "/api/v1/document-requests/{id}/submitted-documents/** – client uploads & views")
    Component(DocumentService, "DocumentService", "Application Service", "DocumentRequest & SubmittedDocument workflows")
    Component(DocumentRequestRepository, "DocumentRequestRepository", "Spring Data Repository", "CRUD for DocumentRequest aggregate")
    Component(S3StorageAdapter, "S3StorageAdapter", "Infrastructure Adapter", "Pre-signed URLs and S3 interactions")

    ' ==== APPOINTMENTS ====
    Component(AppointmentController, "AppointmentController", "REST Controller", "/api/v1/appointments/** – appointments")
    Component(AppointmentService, "AppointmentService", "Application Service", "Appointment lifecycle & status transitions")
    Component(AppointmentRepository, "AppointmentRepository", "Spring Data Repository", "CRUD for Appointment aggregate")

    ' ==== ANALYTICS ====
    Component(AnalyticsController, "AnalyticsController", "REST Controller", "/api/v1/analytics/** – broker analytics")
    Component(AnalyticsService, "AnalyticsService", "Application Service", "Computes broker KPIs and snapshots")
    Component(BrokerMetricsRepository, "BrokerMetricsRepository", "Spring Data Repository", "CRUD for BrokerMetricsSnapshot")

    ' ==== NOTIFICATIONS ====
    Component(NotificationService, "NotificationService", "Application Service", "Composes and logs outbound notifications")
    Component(OutboundNotificationRepository, "OutboundNotificationRepository", "Spring Data Repository", "OutboundNotification aggregate persistence")
    Component(SesEmailAdapter, "SesEmailAdapter", "Infrastructure Adapter", "Sends email via Amazon SES")

    ' ==== CROSS-CUTTING ====
    Component(DomainEventPublisher, "DomainEventPublisher", "Infrastructure", "Publishes domain events in-process")
    Component(SecurityContext, "SecurityContext", "Infrastructure", "Resolves current user & roles from Auth0 token")
  }
}

' Relationships (high-level, internal wiring)
' Security
Rel(UserContextController, SecurityContext, "reads current user", $tags="blue-line")
Rel(SecurityContext, Auth0Adapter, "validates tokens / loads roles", $tags="blue-line")

' Domain events
Rel(TransactionService, DomainEventPublisher, "publishes TransactionStageChanged")
Rel(DocumentService, DomainEventPublisher, "publishes DocumentStatusUpdated")
Rel(AppointmentService, DomainEventPublisher, "publishes AppointmentStatusChanged")

Rel(TransactionService, NotificationService, "publishes notifications on stage change")
Rel(DocumentService, NotificationService, "notifies brokers/clients of document updates")
Rel(AppointmentService, NotificationService, "notifies participants of appointment status")

Rel(web_spa, UserContextController, "Uses", "JSON/REST/HTTPS", $tags="purple-line")
Rel(web_spa, TransactionController, "Uses", "JSON/REST/HTTPS", $tags="purple-line")
Rel(web_spa, DocumentRequestController, "Uses", "JSON/REST/HTTPS", $tags="purple-line")
Rel(web_spa, DocumentSubmissionController, "Uses", "JSON/REST/HTTPS", $tags="purple-line")
Rel(web_spa, AppointmentController, "Uses", "JSON/REST/HTTPS", $tags="purple-line")
Rel(web_spa, AnalyticsController, "Uses", "JSON/REST/HTTPS", $tags="purple-line")
Rel(web_spa, AdminController, "Uses", "JSON/REST/HTTPS", $tags="purple-line")

Rel(UserContextController, UserManagementService, "calls")
Rel(AdminController, UserManagementService, "calls")
Rel(UserManagementService, ClientRepository, "uses")
Rel(UserManagementService, BrokerRepository, "uses")
Rel(UserManagementService, AdminRepository, "uses")
Rel(UserManagementService, Auth0Adapter, "syncs identities")

Rel(TransactionController, TransactionService, "calls")
Rel(TransactionService, TransactionRepository, "uses")
Rel(TransactionService, TimelineService, "delegates stage changes")

Rel(DocumentRequestController, DocumentService, "calls")
Rel(DocumentSubmissionController, DocumentService, "calls")
Rel(DocumentService, DocumentRequestRepository, "uses")
Rel(DocumentService, S3StorageAdapter, "uses")

Rel(AppointmentController, AppointmentService, "calls")
Rel(AppointmentService, AppointmentRepository, "uses")

Rel(AnalyticsController, AnalyticsService, "calls")
Rel(AnalyticsService, BrokerMetricsRepository, "reads")
Rel(AnalyticsService, TransactionRepository, "reads")
Rel(AnalyticsService, DocumentRequestRepository, "reads")
Rel(AnalyticsService, AppointmentRepository, "reads")

Rel(NotificationService, OutboundNotificationRepository, "persists")
Rel(NotificationService, SesEmailAdapter, "uses")

Rel(ClientRepository, main_db, "Reads/Writes", "JDBC/R2DBC")
Rel(BrokerRepository, main_db, "Reads/Writes", "JDBC/R2DBC")
Rel(AdminRepository, main_db, "Reads/Writes", "JDBC/R2DBC")
Rel(TransactionRepository, main_db, "Reads/Writes", "JDBC/R2DBC")
Rel(DocumentRequestRepository, main_db, "Reads/Writes", "JDBC/R2DBC")
Rel(AppointmentRepository, main_db, "Reads/Writes", "JDBC/R2DBC")
Rel(OutboundNotificationRepository, main_db, "Reads/Writes", "JDBC/R2DBC")
Rel(BrokerMetricsRepository, main_db, "Reads/Writes", "JDBC/R2DBC")

Component(BackendEndpoints, "Backend API Endpoints", "Reference Component", "UserContextController: GET /api/v1/me, GET /api/v1/me/transactions, GET /api/v1/me/appointments | AdminController: GET /api/v1/admin/users, POST /api/v1/admin/users, PATCH /api/v1/admin/users/{id}, GET /api/v1/admin/org-settings, PUT /api/v1/admin/org-settings | TransactionController: GET /api/v1/transactions, POST /api/v1/transactions, GET /api/v1/transactions/{id}, PATCH /api/v1/transactions/{id}, GET /api/v1/transactions/{id}/timeline | DocumentRequestController: GET /api/v1/document-requests, POST /api/v1/document-requests, PATCH /api/v1/document-requests/{id} | AppointmentController: GET /api/v1/appointments, POST /api/v1/appointments, PATCH /api/v1/appointments/{id} | AnalyticsController: GET /api/v1/analytics/brokers/{brokerId}/summary, GET /api/v1/analytics/brokers/{brokerId}/history, GET /api/v1/analytics/brokers/{brokerId}/my-day | HealthRoutes (internal): GET /actuator/health, GET /actuator/metrics")

SHOW_LEGEND()
@enduml
